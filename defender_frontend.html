<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Agent Defender Simulation (Remediation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .agent-card { background-color: #161b22; border: 1px solid #30363d; }
        .btn-run { background-color: #0060e0; }
        .btn-run:hover { background-color: #007bff; }
        .output-box { background-color: #010409; border: 1px solid #30363d; }
        .code-input { background-color: #010409; }
        .patch-code { border-color: #238636; }
        .vulnerable-code { border-color: #f85149; }
        .loader {
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            white-space: pre-wrap; /* Allows lines to wrap */
            word-wrap: break-word; /* Allows long tokens to break */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-2 text-[#238636]">Dual-Agent Framework: Defender Agent</h1>
        <p class="text-sm text-[#8b949e] mb-6">Phase 2: Extracting vulnerable functions, generating patches with Llama 3, and validating fixes.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1 agent-card p-6 rounded-lg shadow-xl h-full flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-white">4. Begin Remediation</h2>
                <p class="text-sm text-[#8b949e] mb-3" id="statusMessage">
                    Waiting for input from Attacker Phase (check localStorage).
                </p>
                
                <textarea id="storedCode" rows="10" readonly class="code-input w-full p-3 rounded-md text-sm focus:ring-2 focus:ring-[#58a6ff] resize-none text-[#e6edf3] flex-grow" placeholder="Original Code (Loaded from Local Storage)..."></textarea>
                
                <button id="runRemediation" class="btn-run w-full mt-4 text-white font-semibold py-2 rounded-md transition duration-200 flex items-center justify-center" disabled>
                    <span id="buttonText">Connecting to API (Port 8001)...</span>
                    <div id="loader" class="loader ml-2 hidden"></div>
                </button>
                <p class="text-xs text-[#8b949e] mt-3">Attacker Payloads Stored: <span id="payloadCount">0</span></p>

                </div>

            <div class="lg:col-span-2 space-y-6">

                <div class="agent-card p-6 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-[#238636]">5. Validated Code Patches</h2>
                    <p class="text-sm text-[#8b949e] mb-3">Patches generated by Llama 3 and confirmed to mitigate the attacker payload.</p>
                    <div id="patchOutput" class="output-box p-4 rounded-md min-h-[100px] text-sm space-y-4">
                        <p class="text-[#8b949e]">Awaiting remediation analysis...</p>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="mt-6 flex justify-center">
            <a href="./attacker_frontend.html" class="bg-[#238636] hover:bg-[#2ea043] text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center shadow-xl text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-3.707-8.707l3-3a1 1 0 011.414 1.414L9.414 9H13a1 1 0 110 2H9.414l1.293 1.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Back to Attacker Agent
            </a>
        </div>
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const storedCode = document.getElementById('storedCode');
            const runRemediationButton = document.getElementById('runRemediation');
            const patchOutput = document.getElementById('patchOutput');
            const buttonText = document.getElementById('buttonText');
            const loader = document.getElementById('loader');
            const payloadCount = document.getElementById('payloadCount');
            const statusMessage = document.getElementById('statusMessage');
            
            const DEFENDER_API_URL = 'http://127.0.0.1:8001/api/remediate';
            const API_CHECK_INTERVAL = 2000; 

            let originalCode = localStorage.getItem('originalCodeFull') || '';
            let attackerPayloads;

            try {
                const rawPayloads = localStorage.getItem('attackerPayloads');
                attackerPayloads = rawPayloads ? JSON.parse(rawPayloads) : [];
            } catch (e) {
                console.error("Failed to parse attackerPayloads from localStorage:", e);
                attackerPayloads = [];
            }
            
            // --- Initialization ---
            if (originalCode && attackerPayloads.length > 0) {
                storedCode.value = originalCode.substring(0, 500) + (originalCode.length > 500 ? '\n\n... (Code is truncated for display here but full code is used for analysis)' : '');
                payloadCount.textContent = attackerPayloads.length;
                statusMessage.textContent = `Found ${attackerPayloads.length} findings from the Attacker phase. Ready to remediate.`;
            } else {
                storedCode.value = "Please run the Attacker Agent (on port 8000) first to populate local storage.";
                runRemediationButton.disabled = true;
                return; // Stop initialization if data is missing
            }

            const showLoader = (isLoading) => {
                loader.classList.toggle('hidden', !isLoading);
                runRemediationButton.disabled = isLoading;
                if (isLoading) {
                    buttonText.textContent = 'Running Remediation...';
                } else {
                    if (!runRemediationButton.disabled) {
                        buttonText.textContent = 'Run LLM Remediation & Validation';
                    }
                }
            };

            const renderPatches = (patches) => {
                if (patches.length === 0) {
                    patchOutput.innerHTML = '<p class="text-yellow-400">Remediation complete. No valid patches were generated or validated.</p>';
                    return;
                }
                
                patchOutput.innerHTML = patches.map(patch => `
                    <div class="p-4 agent-card rounded-md shadow-md space-y-2">
                        <h3 class="font-bold text-white">${patch.function_name} <span class="text-[#238636]">(Patch Validated)</span></h3>
                        <p class="text-xs text-[#8b949e]">${patch.cwe_type} at ${patch.location}</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-sm font-semibold text-[#f85149] mb-1">Vulnerable Code</h4>
                                <pre class="output-box p-2 rounded-md text-xs vulnerable-code border overflow-x-auto">${patch.original_code}</pre>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-semibold text-[#238636] mb-1">Validated Patch</h4>
                                <pre class="output-box p-2 rounded-md text-xs patch-code border overflow-x-auto">${patch.patch_code}</pre>
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            const checkApiStatus = () => {
                fetch(DEFENDER_API_URL, { method: 'OPTIONS' })
                    .then(response => {
                        if (response.ok) {
                            buttonText.textContent = 'Run LLM Remediation & Validation';
                            runRemediationButton.disabled = false;
                        } else {
                            throw new Error('Defender API not available');
                        }
                    })
                    .catch(() => {
                        buttonText.textContent = 'Defender API Offline. Please run python defender_agent.py';
                        runRemediationButton.disabled = true;
                        setTimeout(checkApiStatus, API_CHECK_INTERVAL);
                    });
            };

            // Initial API check
            checkApiStatus();

            // --- Main Remediation Handler ---
            runRemediationButton.addEventListener('click', async () => {
                patchOutput.innerHTML = `<p class="text-yellow-400">Request sent to Defender API. Extracting functions and generating fixes...</p>`;
                showLoader(true);

                try {
                    const response = await fetch(DEFENDER_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            code: originalCode, 
                            findings: attackerPayloads 
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || data.error) {
                        patchOutput.innerHTML = `<p class="text-[#f85149] font-bold">Error during remediation:</p><pre class="text-xs text-white mt-2">${data.error || 'Unknown server error.'}</pre>`;
                        return;
                    }

                    renderPatches(data.patches);

                } catch (error) {
                    patchOutput.innerHTML = `<p class="text-[#f85149] font-bold">Network Error:</p><p>Could not connect to the Defender API server at ${DEFENDER_API_URL}. Ensure 'python defender_agent.py' is running.</p>`;
                } finally {
                    showLoader(false);
                }
            });
        });
    </script>
</body>
</html>