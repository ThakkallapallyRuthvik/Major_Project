<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Agent Attacker Simulation (Real-Time)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .agent-card { background-color: #161b22; border: 1px solid #30363d; }
        .btn-run { background-color: #238636; }
        .btn-run:hover { background-color: #2ea043; }
        .output-box { background-color: #010409; border: 1px solid #30363d; }
        .code-input { background-color: #010409; }
        .flaw-high { border-left: 4px solid #f85149; }
        .flaw-medium { border-left: 4px solid #d29922; }
        .flaw-low { border-left: 4px solid #00a6e0; }
        .exploit-code { border-color: #f85149; }
        .loader {
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-2 text-[#58a6ff]">Dual-Agent Framework: Attacker API</h1>
        <p class="text-sm text-[#8b949e] mb-6">Real-time pipeline: Code is sent to the Flask API (Semgrep + Llama 3) for processing.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- CODE INPUT PANEL -->
            <div class="lg:col-span-1 agent-card p-6 rounded-lg shadow-xl h-full flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-white">1. Target Code Submission</h2>
                <p class="text-sm text-[#8b949e] mb-3">Paste the source code (e.g., `vulnerable_app/app.py`).</p>
                
                <textarea id="codeInput" rows="18" class="code-input w-full p-3 rounded-md text-sm focus:ring-2 focus:ring-[#58a6ff] resize-none text-[#e6edf3] flex-grow" placeholder="Paste your vulnerable Python code here..."></textarea>
                
                <button id="runAnalysis" class="btn-run w-full mt-4 text-white font-semibold py-2 rounded-md transition duration-200 flex items-center justify-center" disabled>
                    <span id="buttonText">Connecting to API...</span>
                    <div id="loader" class="loader ml-2 hidden"></div>
                </button>
            </div>

            <!-- RESULTS PANEL -->
            <div class="lg:col-span-2 space-y-6">

                <!-- SAST FINDINGS -->
                <div class="agent-card p-6 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-white">2. Symbolic Analysis (SAST Findings)</h2>
                    <p class="text-sm text-[#8b949e] mb-3">Structural flaws found by Semgrep, feeding the Attacker LLM.</p>
                    <div id="sastOutput" class="output-box p-4 rounded-md min-h-[100px] text-sm space-y-3">
                        <p class="text-[#8b949e]">Waiting for code submission...</p>
                    </div>
                </div>

                <!-- EXPLOIT PAYLOADS -->
                <div class="agent-card p-6 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-[#f85149]">3. Attacker Agent Payloads</h2>
                    <p class="text-sm text-[#8b949e] mb-3">Functional exploit strings generated by Llama 3 adversarial reasoning.</p>
                    <div id="payloadOutput" class="output-box p-4 rounded-md min-h-[100px] text-sm space-y-3">
                        <p class="text-[#8b949e]">Waiting for successful analysis...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const codeInput = document.getElementById('codeInput');
            const runAnalysisButton = document.getElementById('runAnalysis');
            const sastOutput = document.getElementById('sastOutput');
            const payloadOutput = document.getElementById('payloadOutput');
            const buttonText = document.getElementById('buttonText');
            const loader = document.getElementById('loader');
            const API_URL = 'http://127.0.0.1:8000/api/analyze';

            const API_CHECK_INTERVAL = 2000; 

            // --- UI Helper Functions ---
            const showLoader = (isLoading) => {
                loader.classList.toggle('hidden', !isLoading);
                runAnalysisButton.disabled = isLoading;
                if (isLoading) {
                    buttonText.textContent = 'Running Analysis...';
                } else {
                    // Only change button back if API is confirmed online
                    if (!runAnalysisButton.disabled) {
                        buttonText.textContent = 'Run Adversarial Analysis';
                    }
                }
            };

            const getFlawColor = (severity) => {
                if (severity && severity.includes('High')) return 'flaw-high';
                if (severity && severity.includes('Medium')) return 'flaw-medium';
                return 'flaw-low';
            };

            const renderSAST = (findings) => {
                sastOutput.innerHTML = findings.map(flaw => `
                    <div class="p-3 ${getFlawColor(flaw.severity)} pl-3 flex justify-between items-start text-sm bg-[#11161d] rounded-md">
                        <div>
                            <span class="font-bold text-white">${flaw.type} (${flaw.severity})</span>
                            <p class="text-[#8b949e] mt-1">${flaw.description}</p>
                            <code class="text-[#58a6ff] text-xs">${flaw.context}</code>
                        </div>
                    </div>
                `).join('');
            };

            // --- Replacement for the filter logic in renderPayloads function ---
            // --- Replacement for the filter logic in renderPayloads function (around line 102) ---
            // --- Replacement for the renderPayloads function in attacker_frontend.html ---
            const renderPayloads = (payloads) => {
                
                // Define the strings that signify a non-working/refused payload
                const refusalStrings = [
                    "N/A (Configuration Flaw)", // For CWE-668
                    "N/A (LLM Refusal)",       // For Safety Guardrail/Refusal
                    "LLM UNAVAILABLE: Cannot generate exploit." // For server setup error
                ];
                
                // 1. Filter out all refusal strings and empty payloads
                const workingPayloads = payloads.filter(p => 
                    p.exploit && 
                    !refusalStrings.includes(p.exploit.trim())
                );

                if (workingPayloads.length === 0) {
                    payloadOutput.innerHTML = '<p class="text-green-400">Analysis complete. No actionable exploits generated for the findings.</p>';
                    return;
                }

                // 2. Map the filtered (working) payloads to HTML
                payloadOutput.innerHTML = workingPayloads
                    .map(p => {
                        // Clean up the vulnerability type for display
                        const displayType = p.type.split(':')[1] ? p.type.split(':')[1].trim() : p.type;
                        
                        return `
                        <div class="p-3 bg-[#11161d] rounded-md border border-[#30363d] space-y-1">
                            <span class="font-bold text-[#f85149]">${displayType} Exploit</span>
                            <p class="text-white text-xs break-all">${p.context}</p>
                            <div class="mt-1 bg-[#0d1117] p-2 rounded-sm border border-[#30363d] text-[#e6edf3] break-all">
                                <code class="font-mono text-sm">${p.exploit}</code>
                            </div>
                        </div>
                        `;
                    })
                    .join('');
            };
            
            const checkApiStatus = () => {
                // Use a quick OPTIONS request to check if the API is up
                fetch(API_URL, { method: 'OPTIONS' })
                    .then(response => {
                        if (response.ok) {
                            buttonText.textContent = 'Run Adversarial Analysis';
                            runAnalysisButton.disabled = false;
                        } else {
                            throw new Error('API not available');
                        }
                    })
                    .catch(() => {
                        buttonText.textContent = 'API Offline. Please run python api_server.py';
                        runAnalysisButton.disabled = true;
                        setTimeout(checkApiStatus, API_CHECK_INTERVAL);
                    });
            };

            // Initial API check to enable the button
            checkApiStatus();


            // --- Main Analysis Handler (fetch logic) ---
            runAnalysisButton.addEventListener('click', async () => {
                const code = codeInput.value.trim();

                if (!code) {
                    sastOutput.innerHTML = '<p class="text-yellow-400">Please paste code into the submission box to begin analysis.</p>';
                    payloadOutput.innerHTML = '<p class="text-[#8b949e]">Awaiting code...</p>';
                    return;
                }

                sastOutput.innerHTML = `<p class="text-yellow-400">Request sent to API. Running Semgrep and Llama 3...</p>`;
                payloadOutput.innerHTML = `<div class="loader mx-auto"></div>`;

                showLoader(true);

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code })
                    });

                    const data = await response.json();

                    if (!response.ok || data.error) {
                        sastOutput.innerHTML = `<p class="text-[#f85149] font-bold">Error during analysis:</p><pre class="text-xs text-white mt-2">${data.error || 'Unknown server error.'}</pre>`;
                        payloadOutput.innerHTML = `<p class="text-[#f85149]">Analysis Failed.</p>`;
                        return;
                    }

                    if (data.results && data.results.length > 0) {
                        renderSAST(data.results);
                        renderPayloads(data.results);
                        
                        // Save the working payloads for the Defender Agent in the next step
                        localStorage.setItem('attackerPayloads', JSON.stringify(data.results));

                    } else {
                        sastOutput.innerHTML = '<p class="text-green-400">Scan Complete. No critical vulnerabilities found by symbolic analysis.</p>';
                        payloadOutput.innerHTML = '<p class="text-[#8b949e]">No exploits required.</p>';
                    }

                } catch (error) {
                    sastOutput.innerHTML = `<p class="text-[#f85149] font-bold">Network Error:</p><p>Could not connect to the API server at ${API_URL}. Ensure 'python api_server.py' is running in your terminal.</p>`;
                    payloadOutput.innerHTML = `<p class="text-[#f85149]">Connection Failed.</p>`;
                } finally {
                    showLoader(false);
                }
            });

            // Initial instruction when page loads
            sastOutput.innerHTML = '<p class="text-[#8b949e]">Please wait for the API connection check (top button) before pasting code and running analysis.</p>';

        });
    </script>
</body>
</html>